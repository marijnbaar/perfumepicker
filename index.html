<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      charset="UTF-8"
    />
    <title>
      Fragrance
      Haven
    </title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Animate.css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- React and ReactDOM -->
    <script
      src="https://unpkg.com/react@17/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
      crossorigin
    ></script>
    <!-- Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div
      id="root"
    ></div>

    <script
      type="text/babel"
    >
      // ... [Your existing code for color palettes, mockPerfumes, commonNotes, familyColors, ThemeToggle, PerfumeCard, FamilySearch, etc.]

      // -------------------------------------------------------
      // Helper: Call Serverless Function for Llama Embeddings
      // -------------------------------------------------------
      // Instead of calling Hugging Face directly, we call our serverless endpoint.
      async function getEmbeddingFromServerless(
        text,
      ) {
        try {
          const response =
            await fetch(
              "/.netlify/functions/getLlamaEmbedding",
              {
                method:
                  "POST",
                headers:
                  {
                    "Content-Type":
                      "application/json",
                  },
                body: JSON.stringify(
                  {
                    text,
                  },
                ),
              },
            );
          const data =
            await response.json();
          return (
            data.embedding ||
            null
          );
        } catch (error) {
          console.error(
            "Error calling serverless embedding function:",
            error,
          );
          return null;
        }
      }

      // -------------------------------------------------------
      // Cosine Similarity
      // -------------------------------------------------------
      const cosineSimilarity =
        (
          vecA,
          vecB,
        ) => {
          let dot = 0,
            normA = 0,
            normB = 0;
          for (
            let i = 0;
            i <
            vecA.length;
            i++
          ) {
            dot +=
              vecA[
                i
              ] *
              vecB[
                i
              ];
            normA +=
              vecA[
                i
              ] *
              vecA[
                i
              ];
            normB +=
              vecB[
                i
              ] *
              vecB[
                i
              ];
          }
          return (
            dot /
            (Math.sqrt(
              normA,
            ) *
              Math.sqrt(
                normB,
              ))
          );
        };

      // -------------------------------------------------------
      // Main App
      // -------------------------------------------------------
      const App =
        () => {
          const [
            activeTab,
            setActiveTab,
          ] =
            React.useState(
              "home",
            );
          const [
            favorites,
            setFavorites,
          ] =
            React.useState(
              [],
            );
          const [
            searchQuery,
            setSearchQuery,
          ] =
            React.useState(
              "",
            );
          const [
            perfumes,
            setPerfumes,
          ] =
            React.useState(
              [],
            );
          const [
            selectedNotes,
            setSelectedNotes,
          ] =
            React.useState(
              [],
            );
          const [
            isDark,
            setIsDark,
          ] =
            React.useState(
              false,
            );
          const [
            semanticResults,
            setSemanticResults,
          ] =
            React.useState(
              null,
            );

          // Set body background & text based on theme
          React.useEffect(() => {
            document.body.className =
              isDark
                ? "bg-[#914D41] text-[#F9F6DF] min-h-screen"
                : "bg-[#F9F6DF] text-[#914D41] min-h-screen";
          }, [
            isDark,
          ]);

          // Fetch data from JSON or fallback to mock data
          React.useEffect(() => {
            fetch(
              "./scrapedData.json",
            )
              .then(
                (
                  res,
                ) =>
                  res.json(),
              )
              .then(
                (
                  data,
                ) =>
                  setPerfumes(
                    data,
                  ),
              )
              .catch(
                (
                  err,
                ) => {
                  console.error(
                    "Error loading perfume data:",
                    err,
                  );
                  setPerfumes(
                    mockPerfumes,
                  );
                },
              );
          }, []);

          // Re-run Lucide icons after each render
          React.useEffect(
            () => {
              if (
                window.lucide &&
                window
                  .lucide
                  .createIcons
              ) {
                window.lucide.createIcons();
              }
            },
          );

          // Precompute embeddings for all perfumes using our serverless function
          React.useEffect(() => {
            async function computeEmbeddings() {
              if (
                !perfumes.length
              )
                return;
              const updatedPerfumes =
                [];
              for (const perfume of perfumes) {
                // Skip if already has an embedding
                if (
                  perfume.embedding
                ) {
                  updatedPerfumes.push(
                    perfume,
                  );
                  continue;
                }
                // Use name + description as input
                const textForEmbedding = `${perfume.name} ${perfume.description}`;
                const embedding =
                  await getEmbeddingFromServerless(
                    textForEmbedding,
                  );
                updatedPerfumes.push(
                  {
                    ...perfume,
                    embedding,
                  },
                );
              }
              setPerfumes(
                updatedPerfumes,
              );
            }
            computeEmbeddings();
          }, [
            perfumes.length,
          ]);

          // Handle semantic search
          const handleSemanticSearch =
            async () => {
              if (
                !searchQuery
              )
                return;
              const queryEmbedding =
                await getEmbeddingFromServerless(
                  searchQuery,
                );
              if (
                !queryEmbedding
              )
                return;

              const results =
                perfumes
                  .filter(
                    (
                      p,
                    ) =>
                      p.embedding &&
                      Array.isArray(
                        p.embedding,
                      ),
                  )
                  .map(
                    (
                      p,
                    ) => ({
                      ...p,
                      score:
                        cosineSimilarity(
                          queryEmbedding,
                          p.embedding,
                        ),
                    }),
                  );
              results.sort(
                (
                  a,
                  b,
                ) =>
                  b.score -
                  a.score,
              );
              setSemanticResults(
                results,
              );
            };

          // Toggle note for Explore tab
          const toggleNote =
            (
              note,
            ) => {
              setSelectedNotes(
                (
                  prev,
                ) =>
                  prev.includes(
                    note,
                  )
                    ? prev.filter(
                        (
                          n,
                        ) =>
                          n !==
                          note,
                      )
                    : [
                        ...prev,
                        note,
                      ],
              );
              setSemanticResults(
                null,
              );
            };

          // Toggle favorite perfume
          const toggleFavorite =
            (
              perfume,
            ) => {
              setFavorites(
                (
                  prev,
                ) =>
                  prev.some(
                    (
                      p,
                    ) =>
                      p.name ===
                      perfume.name,
                  )
                    ? prev.filter(
                        (
                          p,
                        ) =>
                          p.name !==
                          perfume.name,
                      )
                    : [
                        ...prev,
                        perfume,
                      ],
              );
            };

          // Check if a perfume is in favorites
          const isFavorite =
            (
              perfume,
            ) =>
              favorites.some(
                (
                  p,
                ) =>
                  p.name ===
                  perfume.name,
              );

          // Basic filtering by search query and selected notes
          const filteredPerfumes =
            React.useMemo(() => {
              const data =
                perfumes.length
                  ? perfumes
                  : mockPerfumes;
              return data.filter(
                (
                  perfume,
                ) => {
                  const q =
                    searchQuery.toLowerCase();
                  const matchesSearch =
                    perfume.name
                      .toLowerCase()
                      .includes(
                        q,
                      ) ||
                    (perfume.brand &&
                      perfume.brand
                        .toLowerCase()
                        .includes(
                          q,
                        ));
                  const matchesNotes =
                    selectedNotes.length ===
                      0 ||
                    selectedNotes.some(
                      (
                        note,
                      ) => {
                        const allNotes =
                          [
                            ...(perfume
                              .notes
                              ?.top ||
                              []),
                            ...(perfume
                              .notes
                              ?.middle ||
                              []),
                            ...(perfume
                              .notes
                              ?.base ||
                              []),
                          ].map(
                            (
                              n,
                            ) =>
                              n.toLowerCase(),
                          );
                        return allNotes.includes(
                          note.toLowerCase(),
                        );
                      },
                    );
                  return (
                    matchesSearch &&
                    matchesNotes
                  );
                },
              );
            }, [
              perfumes,
              searchQuery,
              selectedNotes,
            ]);

          // Use semantic results if available; otherwise, use filtered list
          const resultsToDisplay =
            semanticResults ||
            filteredPerfumes;

          return (
            <div className="max-w-7xl mx-auto p-6">
              {/* Theme Toggle */}
              <ThemeToggle
                isDark={
                  isDark
                }
                onToggle={() =>
                  setIsDark(
                    !isDark,
                  )
                }
              />

              {/* Header */}
              <header className="text-center mb-12 animate__animated animate__fadeIn">
                <h1 className="text-4xl font-light mb-4">
                  Fragrance
                  Haven
                </h1>
                <p className="opacity-80">
                  Discover
                  new
                  fragrances
                  and
                  save
                  your
                  favorites
                </p>
              </header>

              {/* Nav Tabs */}
              <nav className="mb-8">
                <div className="flex justify-center gap-4 mb-8">
                  {[
                    "home",
                    "explore",
                    "favorites",
                  ].map(
                    (
                      tab,
                    ) => {
                      const isActive =
                        activeTab ===
                        tab;
                      return (
                        <button
                          key={
                            tab
                          }
                          onClick={() => {
                            setActiveTab(
                              tab,
                            );
                            setSemanticResults(
                              null,
                            );
                          }}
                          className={`px-6 py-3 rounded-full transition-all duration-300 ${
                            isActive
                              ? "bg-[#E8AB8B] text-white"
                              : isDark
                              ? "bg-[#914D41]/50 hover:bg-[#914D41]/80 text-[#F9F6DF]"
                              : "bg-white border border-[#914D41]/20 hover:bg-[#CBDCC2] text-[#914D41]"
                          }`}
                        >
                          {tab
                            .charAt(
                              0,
                            )
                            .toUpperCase() +
                            tab.slice(
                              1,
                            )}
                        </button>
                      );
                    },
                  )}
                </div>
              </nav>

              {/* HOME Tab */}
              {activeTab ===
                "home" && (
                <div className="animate__animated animate__fadeIn">
                  {/* Search Box */}
                  <div
                    className={`p-4 rounded-xl shadow-sm mb-8 ${
                      isDark
                        ? "bg-[#914D41]/40"
                        : "bg-white"
                    }`}
                  >
                    <input
                      type="text"
                      placeholder="Search by name or brand..."
                      value={
                        searchQuery
                      }
                      onChange={(
                        e,
                      ) => {
                        setSearchQuery(
                          e
                            .target
                            .value,
                        );
                        setSemanticResults(
                          null,
                        );
                      }}
                      className={`w-full p-3 rounded-lg focus:ring-2 outline-none ${
                        isDark
                          ? "bg-[#914D41]/40 text-[#F9F6DF] placeholder-[#F9F6DF]/50 focus:ring-[#E8AB8B]"
                          : "bg-[#F9F6DF] text-[#914D41] placeholder-[#914D41]/50 focus:ring-[#E8AB8B]"
                      }`}
                    />
                  </div>
                  {/* Semantic Search Button */}
                  <div className="mb-8">
                    <button
                      onClick={
                        handleSemanticSearch
                      }
                      className="px-4 py-2 bg-[#E8AB8B] text-white rounded-full shadow-md hover:bg-[#914D41] transition-colors"
                    >
                      Semantic
                      Search
                    </button>
                  </div>
                  {/* Perfume Grid */}
                  {resultsToDisplay.length ===
                  0 ? (
                    <p className="opacity-80">
                      No
                      perfumes
                      found
                      matching
                      your
                      criteria.
                    </p>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {resultsToDisplay.map(
                        (
                          perfume,
                          idx,
                        ) => (
                          <PerfumeCard
                            key={
                              idx
                            }
                            perfume={
                              perfume
                            }
                            onAction={
                              toggleFavorite
                            }
                            isFavorite={isFavorite(
                              perfume,
                            )}
                            isDark={
                              isDark
                            }
                          />
                        ),
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* EXPLORE Tab */}
              {activeTab ===
                "explore" && (
                <div className="animate__animated animate__fadeIn">
                  <FamilySearch
                    selectedNotes={
                      selectedNotes
                    }
                    toggleNote={
                      toggleNote
                    }
                    isDark={
                      isDark
                    }
                  />
                  {resultsToDisplay.length ===
                  0 ? (
                    <div className="text-center p-6 rounded-lg opacity-80">
                      No
                      perfumes
                      match
                      the
                      selected
                      notes.
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {resultsToDisplay.map(
                        (
                          perfume,
                          idx,
                        ) => (
                          <PerfumeCard
                            key={
                              idx
                            }
                            perfume={
                              perfume
                            }
                            onAction={
                              toggleFavorite
                            }
                            isFavorite={isFavorite(
                              perfume,
                            )}
                            isDark={
                              isDark
                            }
                          />
                        ),
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* FAVORITES Tab */}
              {activeTab ===
                "favorites" && (
                <div className="animate__animated animate__fadeIn">
                  {favorites.length ===
                  0 ? (
                    <div
                      className={`text-center p-8 rounded-lg ${
                        isDark
                          ? "bg-[#914D41]/40"
                          : "bg-white"
                      } opacity-80`}
                    >
                      <p>
                        Your
                        favorites
                        list
                        is
                        empty.
                      </p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {favorites.map(
                        (
                          perfume,
                          idx,
                        ) => (
                          <PerfumeCard
                            key={
                              idx
                            }
                            perfume={
                              perfume
                            }
                            onAction={
                              toggleFavorite
                            }
                            isFavorite={
                              true
                            }
                            isDark={
                              isDark
                            }
                          />
                        ),
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        };

      // Render App
      ReactDOM.render(
        <App />,
        document.getElementById(
          "root",
        ),
      );
    </script>
  </body>
</html>
